<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Dinero - Wallet Chile</title>
    <meta name="author" content="Miguel Gonzalez Roblero">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css.css">
</head>
<body>

    <div class="chile-header">
        <h4 class="m-0">Enviar Dinero</h4>
    </div>

    <div class="container mt-4">
        
     
        <button id="btn-toggle-contact" class="btn btn-chile-secondary mb-3 w-100">
            + Agregar nuevo contacto
        </button>

        <div id="new-contact-form" class="card p-3 mb-4 shadow-sm" style="display:none;">
            <h5>Nuevo Contacto</h5>
            <form id="addContactForm">
                <div class="mb-2">
                    <input type="text" class="form-control" id="new-name" placeholder="Nombre completo" required>
                </div>
                <div class="mb-2">
                    <select class="form-select" id="new-bank" required>
                        <option value="" selected disabled>Selecciona un Banco</option>
                        <option value="BancoEstado">BancoEstado</option>
                        <option value="Banco de Chile">Banco de Chile</option>
                        <option value="Banco Santander">Banco Santander</option>
                        <option value="BCI">BCI</option>
                        <option value="Scotiabank">Scotiabank</option>
                        <option value="Itaú">Itaú</option>
                        <option value="Banco Falabella">Banco Falabella</option>
                        <option value="Banco Ripley">Banco Ripley</option>
                        <option value="Tenpo">Tenpo</option>
                        <option value="Mach">Mach</option>
                    </select>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control" id="new-cbu" placeholder="Número de cuenta / Alias" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success flex-grow-1">Guardar</button>
                    <button type="button" id="btn-cancel-contact" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>


        <div class="mb-3">
            <input type="text" id="search-contact" class="form-control" placeholder="Buscar en agenda por nombre...">
        </div>
        <h6>Selecciona un contacto:</h6>
        <div id="contacts-list">

        </div>

    
        <div id="send-action-area" class="fixed-bottom bg-white p-3 shadow-lg border-top" style="display:none;">
            <div class="container">
                <p class="text-center mb-2">Enviando a: <strong id="selected-contact-name"></strong></p>
                <div class="mb-3">
                    <label for="transfer-amount" class="form-label">Monto a transferir</label>
                    <input type="number" class="form-control" id="transfer-amount" placeholder="Ej: 1000" min="1">
                </div>
                <button id="btn-confirm-send" class="btn btn-chile w-100">Enviar Dinero</button>
            </div>
        </div>

        <div id="success-msg" class="alert alert-success mt-3" style="display:none;">
            ¡Envío realizado con éxito!
        </div>

        <div class="mt-5 mb-5">
            <a href="menu.html" class="btn btn-link text-secondary">Volver al menú</a>
        </div>
        <div class="text-end mb-4 text-muted" style="margin-top: -2rem;">
            <small>Desarrollado por Miguel Gonzalez Roblero</small>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            let contacts = [
                { id: 1, name: "Juan Pérez", cbu: "000123", bank: "BancoEstado" },
                { id: 2, name: "Maria Gonzalez", cbu: "000456", bank: "Banco Santander" },
                { id: 3, name: "Carlos Ruiz", cbu: "000789", bank: "Banco de Chile" }
            ];

            function renderContacts(filterText = '') {
                $('#contacts-list').empty();
                const filtered = contacts.filter(c => c.name.toLowerCase().includes(filterText.toLowerCase()));
                
                filtered.forEach(c => {
                    $('#contacts-list').append(`
                        <div class="contact-card cursor-pointer" data-id="${c.id}" data-name="${c.name}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${c.name}</strong><br>
                                    <small class="text-muted">${c.bank} - N°: ${c.cbu}</small>
                                </div>
                                <span class="text-primary">></span>
                            </div>
                        </div>
                    `);
                });
            }

            renderContacts();

            $('#btn-toggle-contact').click(function() {
                $('#new-contact-form').slideDown();
                $(this).hide();
            });

            $('#btn-cancel-contact').click(function() {
                $('#new-contact-form').slideUp();
                $('#btn-toggle-contact').fadeIn();
            });

            $('#addContactForm').submit(function(e) {
                e.preventDefault();
                const name = $('#new-name').val();
                const cbu = $('#new-cbu').val();
                const bank = $('#new-bank').val();

                if(name && cbu.length >= 6 && bank) { 
                    contacts.push({ id: Date.now(), name: name, cbu: cbu, bank: bank });
                    renderContacts();
                    $('#new-name').val('');
                    $('#new-cbu').val('');
                    $('#new-bank').val('');
                    $('#new-contact-form').slideUp();
                    $('#btn-toggle-contact').fadeIn();
                } else {
                    alert("Por favor ingrese un nombre y un número de cuenta válido (mínimo 6 caracteres).");
                }
            });

            $('#search-contact').on('input', function() {
                renderContacts($(this).val());
            });

            $(document).on('click', '.contact-card', function() {
                $('.contact-card').removeClass('selected');
                $(this).addClass('selected');
                
                const name = $(this).data('name');
                $('#selected-contact-name').text(name);
                $('#transfer-amount').val(''); // Limpiar monto anterior
                $('#send-action-area').slideDown();
                $('#success-msg').hide();
            });

            $('#btn-confirm-send').click(function() {
                let currentBalance = parseInt(localStorage.getItem('walletBalance')) || 0;
                let amount = parseInt($('#transfer-amount').val());

                if (!amount || amount <= 0) {
                    alert("Por favor ingrese un monto válido mayor a 0.");
                    return;
                }

                if(currentBalance >= amount) { 
                    localStorage.setItem('walletBalance', currentBalance - amount);

                    const contactName = $('#selected-contact-name').text();
                    const newTransaction = {
                        id: Date.now(),
                        type: 'transfer', 
                        amount: amount,
                        date: new Date().toISOString().split('T')[0],
                        desc: 'Envío a ' + contactName
                    };
                    
                    let transactions = JSON.parse(localStorage.getItem('walletTransactions')) || [];
                    transactions.unshift(newTransaction);
                    localStorage.setItem('walletTransactions', JSON.stringify(transactions));
                    
                    $('#send-action-area').slideUp();
                    $('.contact-card').removeClass('selected');
                    $('#success-msg').fadeIn();
                    
                    setTimeout(() => window.location.href = 'menu.html', 2000);
                } else {
                    alert("Saldo insuficiente");
                }
            });
        });
    </script>
</body>
</html>